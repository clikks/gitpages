title: 树莓派安装DS3231硬件时钟
date: 2016-02-01 20:37:06
tags: [linux,树莓派]
categories: 树莓派 
---
　　树莓派2B本身是没有硬件时钟的，每次重启都需要联网重新校准时间，有时候可能会因为网络问题没有获取到正确的时间，导致我们系统上的定时任务等出错，所以，这次选择了DS3231硬件时钟，加装到树莓派上。
　　目前马云家出售的树莓派使用的DS3231时钟大概5元钱左右，直接插在GPIO上就可以配置使用。
![ds3231](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE20160201205909.png)
<!--more-->
# 硬件安装
　　插入GPIO槽的1,3,5,7,9插针，就完成了DS3231的安装。
# 系统配置
　　进入系统，执行下面的命令：
```bash
apt-get install i2c-tools	#安装I2C管理工具
modprobe i2c-dev	#加载I2C设备
i2cdetect -y 1	#扫描总线1的I2C设备
```
执行命令后会显示下面的信息：
![i2c](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE20160201220147.png)
这里因为我是配置过的，所以显示的是UU，正常情况这里显示的应该是68，如果显示是“- -”那么说明时钟硬件安装有问题或者时钟坏掉了。

我们可以查看一下树莓派驱动支持的时钟型号：
```bash
modinfo rtc-ds1307
```
![modinfo](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%94%AF%E6%8C%81%E6%97%B6%E9%92%9F%E5%88%97%E8%A1%A8.png)

# 时钟配置
　　现在我们配置时钟，让树莓派开机能够正确获取硬件时间：
```bash
raspi-config
```
选择第9项**Advanced Options**
![raspi](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE20160201222755.png)
再选择A7项**I2C**，一路选择**Yes**之后重启
![rasp](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE20160201222808.png)
```bash
echo i2c-dev >> /etc/modules	#配置开机加载i2c模块
vi /etc/rc.local	#配置开机同步时钟
#在exit 0前加入以下命令：
echo "ds1307 0x68" > /sys/class/i2c-adapter/i2c-1/new_device	#开机加载DS3231时钟设备
hwclock -s	#将系统时钟调整为与目前的硬件时钟一致
```
　　完成以上步骤之后，我们确认目前系统的时间是正确的，然后执行**hwclock -w**将硬件时钟调整为跟目前系统时间一致。

现在重启树莓派，查看我们的配置是否生效：
```bash
i2cdetect -y 1
```
可以看到已经是下面这样的：
![uu](http://7xqo9u.com1.z0.glb.clouddn.com/ds3231%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE20160201225046.png)
我们的设备已经生效，现在即使没有网络，树莓派开机也可以正确获取时间。